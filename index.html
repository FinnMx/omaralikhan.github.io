<html>
 <meta charset="UTF-8"> 
	<head>
		<title>Tracy Demo</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<script src="js/three.min.js"></script>
		<script src="js/cannon.min.js"></script>
		<script src="build/cannon.js"></script>
	    <script src="build/cannon.demo.js"></script>
	    <script src="libs/dat.gui.js"></script>
	    <script src="libs/Three.js"></script>
	    <script src="libs/TrackballControls.js"></script>
	    <script src="libs/Detector.js"></script>
	    <script src="libs/Stats.js"></script>
	    <script src="libs/smoothie.js"></script>
		<script>
		var demo = new CANNON.Demo();
        var world = demo.getWorld();
        var vehicles = [];

        function Tracy(x,y,z)
        {
            var chassisShape = new CANNON.Box(new CANNON.Vec3(2.5, 2.5,0.5));
            var chassisBody = new CANNON.Body({ mass: 150 });
            chassisBody.addShape(chassisShape);
            chassisBody.position.set(x,y,z);
            chassisBody.angularVelocity.set(0, 0, 0.7);
            demo.addVisual(chassisBody);

            // Settings for the vehicle.
            var options = {
                radius: 1.4,
                directionLocal: new CANNON.Vec3(0, 0, -1),
                suspensionStiffness: 30,
                suspensionRestLength: 0.3,
                frictionSlip: 1,
                dampingRelaxation: 2.3,
                dampingCompression: 4.4,
                maxSuspensionForce: 100000,
                rollInfluence:  0.01,
                axleLocal: new CANNON.Vec3(0, 1, 0),
                chassisConnectionPointLocal: new CANNON.Vec3(1, 1, 0),
                maxSuspensionTravel: 0.3,
                customSlidingRotationalSpeed: -30,
                useCustomSlidingRotationalSpeed: true
            };

            // Create the vehicle
            var vehicle = new CANNON.RaycastVehicle({
                chassisBody: chassisBody,
            });

            options.chassisConnectionPointLocal.set(1.5, 2.5, 0);
            vehicle.addWheel(options);

            options.chassisConnectionPointLocal.set(1.5, -2.5, 0);
            vehicle.addWheel(options);

            options.chassisConnectionPointLocal.set(-1.5, 2.5, 0);
            vehicle.addWheel(options);

            options.chassisConnectionPointLocal.set(-1.5, -2.5, 0);
            vehicle.addWheel(options);

            vehicle.addToWorld(world);

            // Create wheel shapes.
            vehicle.wheelBodies = [];
            for(var i=0; i<vehicle.wheelInfos.length; i++){
                var wheel = vehicle.wheelInfos[i];
                var cylinderShape = new CANNON.Cylinder(wheel.radius, wheel.radius, wheel.radius / 2, 20);
                var wheelBody = new CANNON.Body({
                    mass: 0
                });
                wheelBody.type = CANNON.Body.KINEMATIC;
                wheelBody.collisionFilterGroup = 0; // turn off collisions
                var q = new CANNON.Quaternion();
                q.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), Math.PI / 2);
                wheelBody.addShape(cylinderShape, new CANNON.Vec3(), q);
                vehicle.wheelBodies.push(wheelBody);
                demo.addVisual(wheelBody);
                world.addBody(wheelBody);
            }

            vehicles.push(vehicle);
        }

        demo.addScene("car",function(){
        	// Initialise world settings.
            world.broadphase = new CANNON.SAPBroadphase(world);
            world.gravity.set(0, 0, -10);
            world.defaultContactMaterial.friction = 0.1;

            // Create materials.
            var groundMaterial = new CANNON.Material("groundMaterial");
            var wheelMaterial = new CANNON.Material("wheelMaterial");

            // Define ground to wheel material contact constraints.
            var wheelGroundContactMaterial = window.wheelGroundContactMaterial = new CANNON.ContactMaterial(wheelMaterial, groundMaterial, {
                friction: 0.3,
                restitution: 0,
                contactEquationStiffness: 1000
            });

            // Define ground to ground material contact constraints.
            var ground_ground_cm = new CANNON.ContactMaterial(groundMaterial, groundMaterial, {
                friction: 0.4,
                restitution: 0.3,
                contactEquationStiffness: 1e8,
                contactEquationRelaxation: 3,
                frictionEquationStiffness: 1e8,
                frictionEquationRegularizationTime: 3,
            });

            // We must add the contact materials to the world
            world.addContactMaterial(ground_ground_cm);
            world.addContactMaterial(wheelGroundContactMaterial);

            // Create four tracies and set their x,y,z positions.
            Tracy(60,0,4);
            Tracy(30,5,4);
            Tracy(-20,0,4);
            Tracy(-60,0,4);


            // Update wheels
            world.addEventListener('postStep', function(){
                for (var j = 0; j < vehicles.length; j++ ) {
                    for (var i = 0; i < vehicles[j].wheelInfos.length; i++) {
                        vehicles[j].updateWheelTransform(i);
                        var t = vehicles[j].wheelInfos[i].worldTransform;
                        var wheelBody = vehicles[j].wheelBodies[i];
                        wheelBody.position.copy(t.position);
                        wheelBody.quaternion.copy(t.quaternion);
                    }
                }
            });

            createFloor()

            // Create a ramp represented as a polyhedron.
            var polyhedronShape = createTetra();
            var polyhedronBody = new CANNON.Body({ mass: 1000, material: groundMaterial });
            polyhedronBody.addShape(polyhedronShape);
            polyhedronBody.position.set(10,-5,1);
            polyhedronBody.quaternion.setFromAxisAngle(new CANNON.Vec3(0,0,1),THREE.Math.degToRad(-20));
            world.addBody(polyhedronBody);
            demo.addVisual(polyhedronBody);

        });

        demo.start();
        var maxSteerVal = 0.5;
        var maxForce = 500;
        var brakeForce = 1000000;
        var rotationForce = 8*maxForce;

        /**
         * Renders the ground as a height field.
         */
        function createFloor()
        {
            // Create a 64 x 16 matrix to store our height field.
            var matrix = [];
            var sizeX = 64,
                sizeY = 16;

            for (var i = 0; i < sizeX; i++) {
                matrix.push([]);
                for (var j = 0; j < sizeY; j++) {
                    height = 1;
                    matrix[i].push(height);
                }
            }

            var hfShape = new CANNON.Heightfield(matrix, {
                elementSize: 200 / sizeX
            });
            // Set mass to 0 so it is a static body and unaffected by gravity.
            var hfBody = new CANNON.Body({ mass: 0 });
            hfBody.addShape(hfShape);
            hfBody.position.set(-sizeX * hfShape.elementSize / 2, -sizeY * hfShape.elementSize / 2, -1);
            world.addBody(hfBody);
            demo.addVisual(hfBody);
        }


        function createTetra()
        {
            var verts = [new CANNON.Vec3(0,0,0),
                         new CANNON.Vec3(20,0,0),
                         new CANNON.Vec3(0,20,0),
                         new CANNON.Vec3(0,0,5)];
            var offset = -0.35;

            for(var i=0; i<verts.length; i++)
            {
                var v = verts[i];
                v.x += offset;
                v.y += offset;
                v.z += offset;
            }
            return new CANNON.ConvexPolyhedron(verts,[[0,3,2],[0,1,3],[0,2,1],[1,2,3]]);
        }

        // Rotates the vehicle to the left infinitely.
        vehicles[0].applyEngineForce(rotationForce, 1);
        vehicles[0].applyEngineForce(rotationForce, 3);
        vehicles[0].applyEngineForce(-rotationForce, 0);
        vehicles[0].applyEngineForce(-rotationForce, 2);

        // Rotates the vehicle to the right infinitely.
        vehicles[2].applyEngineForce(-rotationForce, 1);
        vehicles[2].applyEngineForce(-rotationForce, 3);
        vehicles[2].applyEngineForce(rotationForce, 0);
        vehicles[2].applyEngineForce(rotationForce, 2);

        vehicles[1].applyEngineForce(230, 0);
        vehicles[1].applyEngineForce(230, 1);

        function stop()
        {
            vehicles[1].setBrake(300,0);
            vehicles[1].setBrake(300,1);
            vehicles[1].setBrake(300,2);
            vehicles[1].setBrake(300,3);
        }

        setTimeout(stop, 4000);

        // Keyboard Controls
        document.onkeydown = handler;
        document.onkeyup = handler;

        // Extra boost multiplier to make the car move slower or faster.
        var boost = 0.5;

        function handler(event){
            var up = (event.type == 'keyup');

            if(!up && event.type !== 'keydown'){
                return;
            }

            // Set breaks to reset car to initial position.
            vehicles[3].setBrake(0, 0);
            vehicles[3].setBrake(0, 1);
            vehicles[3].setBrake(0, 2);
            vehicles[3].setBrake(0, 3);

            switch(event.keyCode){
            case 38: // forward
                vehicles[3].applyEngineForce(up ? 0 : -maxForce*boost, 2);
                vehicles[3].applyEngineForce(up ? 0 : -maxForce*boost, 3);
                break;

            case 40: // backward
                vehicles[3].applyEngineForce(up ? 0 : maxForce*boost, 2);
                vehicles[3].applyEngineForce(up ? 0 : maxForce*boost, 3);
                break;

            case 66: // b
                vehicles[3].setBrake(brakeForce, 0);
                vehicles[3].setBrake(brakeForce, 1);
                vehicles[3].setBrake(brakeForce, 2);
                vehicles[3].setBrake(brakeForce, 3);
                break;

            case 39: // right
                vehicles[3].applyEngineForce(up ? 0 : rotationForce, 1);
                vehicles[3].applyEngineForce(up ? 0 : rotationForce, 3);
                vehicles[3].applyEngineForce(up ? 0 : -rotationForce, 0);
                vehicles[3].applyEngineForce(up ? 0 : -rotationForce, 2);
                break;

            case 37: // left
                vehicles[3].applyEngineForce(up ? 0 : -rotationForce, 1);
                vehicles[3].applyEngineForce(up ? 0 : -rotationForce, 3);
                vehicles[3].applyEngineForce(up ? 0 : rotationForce, 0);
                vehicles[3].applyEngineForce(up ? 0 : rotationForce, 2);
                break;

            }
        }
		</script>
	</body>
</html>